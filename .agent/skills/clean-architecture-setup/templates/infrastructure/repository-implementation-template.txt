{{REPOSITORY_IMPLEMENTATION_NAME}}

Description: {{DESCRIPTION}} using {{DATABASE_TYPE}}

Implements: {{REPOSITORY_INTERFACE}}

---

<?php

namespace App\Infrastructure\Persistence;

use App\Domain\{{CONTEXT}}\Entities\{{ENTITY_NAME}};
use App\Domain\{{CONTEXT}}\Repositories\{{REPOSITORY_INTERFACE}};
use App\Domain\{{CONTEXT}}\ValueObjects\{{ENTITY_NAME}}Id;
use Illuminate\Support\Facades\DB;

final class {{REPOSITORY_IMPLEMENTATION_NAME}} implements {{REPOSITORY_INTERFACE}}
{
    private const TABLE = '{{TABLE_NAME}}';
    
    public function save({{ENTITY_NAME}} $entity): void
    {
        DB::table(self::TABLE)->updateOrInsert(
            ['id' => $entity->getId()->getValue()],
            $this->mapToDatabase($entity)
        );
    }
    
    public function getById({{ENTITY_NAME}}Id $id): {{ENTITY_NAME}}
    {
        $record = DB::table(self::TABLE)->find($id->getValue());
        
        if (!$record) {
            throw new {{ENTITY_NAME}}NotFoundException(
                "{{ENTITY_NAME}} not found: {$id->getValue()}"
            );
        }
        
        return $this->mapToEntity($record);
    }
    
    public function findBy{{CRITERIA}}({{CRITERIA_TYPE}} ${{CRITERIA_PARAM}}): array
    {
        $records = DB::table(self::TABLE)
            ->where('{{COLUMN}}', ${{CRITERIA_PARAM}}->getValue())
            ->get();
        
        return $records->map(fn($record) => $this->mapToEntity($record))->all();
    }
    
    public function delete({{ENTITY_NAME}}Id $id): void
    {
        DB::table(self::TABLE)->where('id', $id->getValue())->delete();
    }
    
    public function nextId(): {{ENTITY_NAME}}Id
    {
        $maxId = DB::table(self::TABLE)->max('id') ?? 0;
        return new {{ENTITY_NAME}}Id($maxId + 1);
    }
    
    private function mapToEntity(object $record): {{ENTITY_NAME}}
    {
        return new {{ENTITY_NAME}}(
            new {{ENTITY_NAME}}Id($record->id),
            new {{VALUE_OBJECT_1}}($record->{{FIELD_1}}),
            new {{VALUE_OBJECT_2}}($record->{{FIELD_2}})
        );
    }
    
    private function mapToDatabase({{ENTITY_NAME}} $entity): array
    {
        return [
            '{{FIELD_1}}' => $entity->get{{FIELD_1_CAPITALIZED}}()->getValue(),
            '{{FIELD_2}}' => $entity->get{{FIELD_2_CAPITALIZED}}()->getValue(),
            'updated_at' => now()
        ];
    }
}
